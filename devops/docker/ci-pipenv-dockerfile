ARG HASH
ARG PY_VER
FROM "python:$PY_VER-slim@$HASH"

LABEL maintainer="Freedom of the Press Foundation"

RUN apt-get update &&\
    apt-get install --no-install-recommends git paxctl -y &&\
    apt-get clean && rm -rf /var/lib/apt/lists/* &&\
    rm -rf /usr/share/doc/ && rm -rf /usr/share/man &&\
    rm -rf /usr/share/locale

ARG USER
ARG PIPENV_VER

RUN adduser --gecos "" --uid ${USER} --disabled-password pyuser
RUN pip install pipenv==${PIPENV_VER}
COPY pipenv-wrapper.sh /bin/pipenv-wrapper.sh
RUN chmod +x /bin/pipenv-wrapper.sh
RUN find /usr/local/bin -type f \( -name 'pyt*' -o -name 'pipenv' \) \
            -exec paxctl -cm '{}' \;

USER pyuser

ENTRYPOINT ["/bin/pipenv-wrapper.sh"]
